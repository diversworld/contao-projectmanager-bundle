<h1> Gantt Twig </h1>
<!-- Projektauswahl (wird angezeigt, wenn kein Projekt gewÃ¤hlt wurde oder um zu wechseln) -->
<form method="get" action="contao" style="margin: .5rem 0;">
    <input type="hidden" name="do" value="{{ do|default('project_gantt')|e('html_attr') }}">
    {% if table %}
        <input type="hidden" name="table" value="{{ table|e('html_attr') }}">
    {% endif %}
    {% if do == 'project_collection' %}
        <input type="hidden" name="key" value="gantt">
    {% endif %}
    {% if rt is defined and rt %}
        <input type="hidden" name="rt" value="{{ rt|e('html_attr') }}">
    {% endif %}

    <label for="projectSelect"><strong>Projekt wÃ¤hlen:</strong></label>
    <select id="projectSelect" name="id" onchange="this.form.submit()" style="min-width: 240px;">
        <option value="0">â€“ Bitte wÃ¤hlen â€“</option>
        {% if projects is not empty %}
            {% for p in projects %}
                <option value="{{ p.id }}" {{ (selectedProjectId|default(0)) == p.id ? 'selected' : '' }}>
                    {{ p.title }}
                </option>
            {% endfor %}
        {% endif %}
    </select>
    <noscript><button type="submit">Anzeigen</button></noscript>
</form>


<script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.umd.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css">

<div id="gantt"></div>
<div id="sideheader"></div>
<div id="popup"></div>

<div id="gantt-container">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const tasks = {{ ganttTasks|raw }};
            const container = document.querySelector("#gantt");

            if (!tasks.length) {
                container.innerHTML = "<p><em>Keine Tasks vorhanden.</em></p>";
                return;
            }

            const gantt = new Gantt(container, tasks, {
                view_mode: "Day",
                date_format: "DD.MM.YYYY",
                language: "de",
                view_mode_select: false,
                infinite_padding: true,
                container_height: 600,
                bar_height: 24,
                column_width: 24,
                today_button: true,      // âœ… Button anzeigen
                scroll_to: "today",      // âœ… beim Laden zu Heute springen
            });
            console.log(tasks.filter(t => t.dependencies));

            // ðŸ”§ Fallback: Falls der eingebaute Button nichts macht, hier abfangen
            document.addEventListener("click", e => {
                if (e.target.closest(".gantt-today-btn")) {
                    gantt.scroll_current();
                }
            });

            // Milestones als Raute rendern
            gantt.after_render = function() {
                gantt.tasks.forEach(t => {
                    if (t.custom_class === 'milestone') {
                        const wrapper = document.querySelector(`.bar-wrapper[data-id="${t.id}"]`);
                        if (wrapper) {
                            const bar = wrapper.querySelector('rect.bar');
                            if (bar) {
                                const width = parseFloat(bar.getAttribute('width'));
                                const height = parseFloat(bar.getAttribute('height'));
                                const x = parseFloat(bar.getAttribute('x')) + width/2;
                                const y = parseFloat(bar.getAttribute('y')) + height/2;

                                bar.setAttribute('width', 12);
                                bar.setAttribute('height', 12);
                                bar.setAttribute('rx', 0);

                                wrapper.setAttribute('transform', `rotate(45 ${x} ${y})`);
                            }
                        }
                    }
                });
            };
        });
    </script>
</div>
